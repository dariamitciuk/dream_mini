# syntax=docker/dockerfile:experimental
 
FROM pytorch/pytorch:1.5-cuda10.1-cudnn7-runtime
 
WORKDIR /src
 
ARG PRETRAINED_MODEL_PATH
ENV PRETRAINED_MODEL_PATH ${PRETRAINED_MODEL_PATH}
ARG SERVICE_PORT
ENV SERVICE_PORT ${SERVICE_PORT}


COPY ./setup.sh /src/setup.sh
RUN  ["sh", "/src/setup.sh"]


COPY ./requirements.txt /src/requirements.txt
RUN apt-get update && apt-get install -y gcc
RUN pip install --upgrade pip
RUN pip install pycocotools
RUN pip install -r /src/requirements.txt
 
RUN python -c 'from transformers import GPT2Tokenizer; GPT2Tokenizer.from_pretrained("gpt2");'

COPY . /src
 
HEALTHCHECK --interval=5s --timeout=90s --retries=3 CMD curl --fail 127.0.0.1:${SERVICE_PORT}/healthcheck || exit 1
 
CMD gunicorn --workers=1 server:app -b 0.0.0.0:${SERVICE_PORT} --timeout=300